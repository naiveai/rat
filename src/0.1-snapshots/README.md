# Naive snapshot-type commits

The fundamental motivation behind a version control system is to keep track
of changes to a file or set of files so you can look back at or revert to old
versions, and collaborate on them systematically.

The most basic way to implement a VCS is something we've all likely done,
whether knowingly or unknowingly, which is to create copies of file(s) at
points where we might need to access them again, renaming them to reflect their
version, like `thesis_draft_1`, `thesis_draft_2`, etc, with `thesis` itself
being the file with work still in progress. In git terminology, each of these
versions is called a commit, and the in-progress version is called the working
file, or the working directory if it's multiple files.

We can make a hidden folder called `.rat` that stores our past commits. This
is analogous to the `.git` directory you'll have seen inside a git repository
if you run `ls -a` inside of it. We'll store that name in a constant.

```rust
{{#rustdoc_include src/main.rs:nest_directory}}
```

## Basics

In our main function, we set up the basic structure of our program. Eventually,
we'll be adding many different commands, but for now we need to able to do two
things: `init` to initialize a new nest, and create a new `commit`. We'll
first use [`std::env::args`][args] to retrieve our command line arguments
and find out what subcommand we need to run.

```rust
{{#rustdoc_include src/main.rs:main_subcommands}}
```

Then we can match on the resulting subcommand to decide which function to run.

```rust
{{#rustdoc_include src/main.rs:subcommand_match}}
```

## Commit

Let's write `commit` first, since it's the most fundamental unit. In order to
make a commit, we just need to copy the current contents of the working
directory into a special commit folder inside our nest.

```rust
{{#rustdoc_include src/main.rs:commit_creation}}
```

However, you may notice that we need to know what the `new_head_number` is
for this code to work. Each time we create a new commit, its ID has to come
from the previous commit's ID plus one. So we keep track of the "head"
commit in a special file containing its ID. *Before* we can create a commit,
then, we must read and parse that `HEAD` file, like so:

```rust
{{#rustdoc_include src/main.rs:commit_head_parse}}
```

## Init

Based on this simple `commit` function, what we need to initialize in `init`
becomes quite obvious.

```rust
{{{#rustdoc_include src/main.rs:init}}
```

## Nest Structure Summary

Here's an example that would be generated by 2 commits in a nest containing only
a single file. In this case, `HEAD` would only contain the value `2`.

```
thesis/
    .rat/
        HEAD
        commit-0/
            thesis.latex
        commit-1/
            thesis.latex
    thesis.latex
```

[args]: https://doc.rust-lang.org/std/env/fn.args.html
